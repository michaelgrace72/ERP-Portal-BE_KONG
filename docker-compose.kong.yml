version: '3.8'

services:
  # PostgreSQL for Kong's configuration
  kong-database:
    image: postgres:15-alpine
    container_name: kong-database
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kongpass
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - kong-net
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "kong"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kong Gateway
  kong:
    image: kong:ubuntu
    container_name: kong-gateway
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kongpass
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_LOG_LEVEL: info
    ports:
      - "8000:8000"  # Kong Proxy (public API gateway)
      - "8001:8001"  # Kong Admin API
    networks:
      - kong-net
      - internal
    depends_on:
      kong-database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kong Database Bootstrap (run migrations)
  kong-migration:
    image: kong:ubuntu
    container_name: kong-migration
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kongpass
    command: kong migrations bootstrap
    networks:
      - kong-net
    depends_on:
      kong-database:
        condition: service_healthy
    restart: on-failure

  # Portal Service (existing)
  portal-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: portal-service
    environment:
      - DB_HOST=portal-postgres
      - DB_PORT=5432
      - DB_USER=portal
      - DB_PASSWORD=portal123
      - DB_NAME=portal_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=redis123
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=3000
    ports:
      - "3000:3000"  # Exposed for direct access during development
    networks:
      - internal
    depends_on:
      - portal-postgres
      - redis
    restart: unless-stopped

  # PostgreSQL for Portal Service
  portal-postgres:
    image: postgres:15-alpine
    container_name: portal-postgres
    environment:
      POSTGRES_DB: portal_db
      POSTGRES_USER: portal
      POSTGRES_PASSWORD: portal123
    volumes:
      - portal-db-data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "portal"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for session storage
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --requirepass redis123
    volumes:
      - redis-data:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Example Inventory Service (for testing upstream)
  # inventory-service:
  #   build:
  #     context: ../inventory-service
  #     dockerfile: Dockerfile
  #   container_name: inventory-service
  #   environment:
  #     - DB_HOST=inventory-postgres
  #     - SERVER_PORT=3000
  #   networks:
  #     - internal  # Only accessible through Kong
  #   depends_on:
  #     - inventory-postgres
  #   restart: unless-stopped

volumes:
  kong-db-data:
    driver: local
  portal-db-data:
    driver: local
  redis-data:
    driver: local

networks:
  # Kong network for Kong Gateway and its database
  kong-net:
    driver: bridge
    internal: false
  
  # Internal network for services (NOT exposed to internet)
  # Only Kong has access to both networks
  internal:
    driver: bridge
    internal: false  # Set to true in production to block internet access
